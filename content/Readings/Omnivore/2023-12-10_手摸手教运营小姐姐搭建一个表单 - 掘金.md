---
id: ef9b954c-97ec-11ee-aa40-abfa84ba257b
title: |
  æ‰‹æ‘¸æ‰‹æ•™è¿è¥å°å§å§æ­å»ºä¸€ä¸ªè¡¨å• - æ˜é‡‘
author: |
  å¤èŒ—å‰ç«¯å›¢é˜Ÿ
date_saved: 2023-12-10 20:42:41
date_published: 2023-12-10 20:42:41
draft: true
---

# æ‰‹æ‘¸æ‰‹æ•™è¿è¥å°å§å§æ­å»ºä¸€ä¸ªè¡¨å• - æ˜é‡‘
#Omnivore

[Read on Omnivore](https://omnivore.app/me/-18c5785d67b)

[Read Original](https://juejin.cn/post/7311005519613984778)

date_saved: 2023-12-10 20:42:41

date_published: 2023-12-10 20:42:41

--- 

# Full Content: 

##  æ‰‹æ‘¸æ‰‹æ•™è¿è¥å°å§å§æ­å»ºä¸€ä¸ªè¡¨å• 

![æ˜Œé¹.png](https://proxy-prod.omnivore-image-cache.app/0x0,sfwe4Jaomb1bu_Jrq3OzbllFi_FmnE73EnXcVw3MJbhc/https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7f8ea6caf23243faa59fb0740527b22a~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3840&h=1200&s=1294969&e=png&b=fef8f3)

## å‰è¨€

ç”±äºæœ¬äººæ‰€åœ¨çš„ä¸šåŠ¡ç»å¸¸éœ€è¦ä¸‹å‘ä¸€äº›è¡¨å•ç±»å‹ä»»åŠ¡ç»™é—¨åº—ï¼Œè€Œæ‰€æœ‰è¡¨å•éƒ½æ˜¯å‰ç«¯åŸºäº[formily](https://link.juejin.cn/?target=https%3A%2F%2Fformilyjs.org%2F "https://formilyjs.org/")è¿›è¡Œé…ç½®çš„ï¼Œæ‰€ä»¥ç»å¸¸ä¼šå’Œè¿è¥å°å§å§æ‰“äº¤é“ï¼Œè¿™æ˜¯èƒŒæ™¯ã€‚

åœ¨ä¸€ä¸ªæ™®æ™®é€šé€šçš„å·¥ä½œæ—¥ï¼Œå½“æˆ‘æ­£åœ¨åŸ‹å¤´å†™ä»£ç çš„æ—¶å€™ï¼Œçªç„¶ä¼ æ¥ä¸€å£°â€œé’‰â€çš„æ¶ˆæ¯å£°ï¼Œæ‰“å¼€æ¶ˆæ¯ä¸€çœ‹ï¼Œæˆ‘ä»¬çš„è¿è¥å°å§å§ç»™æˆ‘å‘äº†ä¸€å¥â€œåœ¨å—ï¼Ÿâ€ï¼Œæ­£å½“æˆ‘åœ¨æ€è€ƒå¦‚ä½•å›å¤çš„æ—¶å€™ï¼Œå•ªçš„ä¸€ä¸‹ï¼Œå¾ˆå¿«å•Šï¼Œå°å§å§åˆç»™æˆ‘å‘äº†ä¸€å¤§å †æ¶ˆæ¯ï¼Œå®šç›ä¸€çœ‹ï¼ŒåŸæ¥æ˜¯æ¥æ‰¾æˆ‘é…ç½®æ•°ä¸ªè¡¨å•ï¼Œæ­¤æ—¶æ¶ˆæ¯å·²ç»å˜ä¸ºå·²è¯»äº†ï¼Œæ²¡æœ‰åŠæ³•ï¼Œåªèƒ½â€œæ‰‹å†™â€è¡¨å•é…ç½®ï¼Œç­‰é…å¥½è¡¨å•åæ—¶é—´å·²ç»æ¥åˆ°äº†ä¸­åˆï¼Œåˆåˆ°äº†å¹²é¥­çš„æ—¶é—´ï¼šï¼‰

![](https://proxy-prod.omnivore-image-cache.app/0x0,sBDEKuNOJWk-X4-U0KRwGIFxUqQ_rLjZc6HE274YBsQc/https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/12dfc7cc2c0d4c09a3327e0eef5b67fd~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=240&h=240&s=17223&e=jpg&b=fcfcfc)

è¿™ç§æƒ…å†µåœ¨æˆ‘ä»¬æ—¥å¸¸å·¥ä½œä¸­ç»å¸¸å‘ç”Ÿï¼Œè™½ç„¶ä¸æ˜¯æ¯å¤©å¦‚æ­¤ï¼Œä½†ä¸€å‘¨æ¥ä¸ªä¸¤ä¸‰æ¬¡ï¼Œè¿˜æ˜¯éå¸¸æŠ˜è…¾äººçš„ã€‚å°½ç®¡æˆ‘ä»¬ç»„å†…åæ¥å»ºç«‹äº†ä¸€ä¸ªè½®ç­æœºåˆ¶æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œä½†è¿™åªæ˜¯æ²»æ ‡ä¸æ²»æœ¬ï¼Œæ—¶é—´æµªè´¹ä»ç„¶æ˜¯ä¸€ä¸ªå®å®åœ¨åœ¨çš„é—®é¢˜ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å†³å®šå¼€å‘ä¸€ä¸ªè¡¨å•æ­å»ºå¹³å°ï¼Œè®©è¿è¥å°å§å§èƒ½å¤Ÿ**è‡ªè¡Œå»é…ç½®è¡¨å•ï¼Œæ— éœ€å¼€å‘ä»‹å…¥**ï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½ ~~å·æ‡’~~ æŠ•å…¥æ›´å¤šçš„æ—¶é—´å»æ‰¿æ¥å…¶ä»–ä¸šåŠ¡éœ€æ±‚ã€‚

## æ¶æ„è®¾è®¡

åœ¨ç«‹é¡¹ä¹‹åˆæˆ‘ä»¬ç»„å†…ä¹Ÿè®¨è®ºè¿‡æ˜¯è‡ªç ”ä¸€ä¸ªè¡¨å•æ­å»ºå¹³å°å¥½å‘¢è¿˜æ˜¯ç›´æ¥ç”¨å®˜æ–¹çš„[designable](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Falibaba%2Fdesignable "https://github.com/alibaba/designable")ï¼Œæœ€ç»ˆæˆ‘ä»¬é€‰æ‹©äº†è‡ªç ”ï¼ŒåŸå› æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š

* [designable](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Falibaba%2Fdesignable "https://github.com/alibaba/designable") ç›¸å¯¹äºæˆ‘ä»¬çš„ä¸šåŠ¡è€Œè¨€åé‡ï¼Œå¾ˆå¤šåŠŸèƒ½æˆ‘ä»¬å¹¶ä¸éœ€è¦
* é’ˆå¯¹å†…éƒ¨ä¸šåŠ¡éœ€æ±‚æˆ‘ä»¬ä¼šæœ‰è¾ƒå¤šå®šåˆ¶åŒ–çš„åŠŸèƒ½ï¼Œæ”¹é€ [designable](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Falibaba%2Fdesignable "https://github.com/alibaba/designable")æˆæœ¬å¯èƒ½ä¼šæ›´å¤§
* æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´é€‚åˆè¿è¥ä½¿ç”¨çš„å¹³å°ï¼Œ[designable](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Falibaba%2Fdesignable "https://github.com/alibaba/designable")åœ¨æŸäº›æ–¹é¢å¯èƒ½æ›´é€‚åˆæœ‰ç¼–ç¨‹ç»éªŒçš„å¼€å‘äººå‘˜

æ—¢ç„¶ç¡®å®šäº†æ–¹å‘ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç€æ‰‹è®¾è®¡ä¸€å¥—æŠ€æœ¯æ–¹æ¡ˆå»å®ç°ä¸€ä¸ªè¡¨å•æ­å»ºå¹³å°ï¼š

* æ”¯æŒå¯è§†åŒ–æ­å»ºé…ç½®ï¼Œæ‰€è§å³æ‰€å¾—
* èƒ½æ”¯æŒå†…éƒ¨ç»„ä»¶åº“æ‰€æœ‰è¡¨å•ç»„ä»¶ä½¿ç”¨
* å°½å¯èƒ½é™ä½å­¦ä¹ æˆæœ¬ï¼Œæ–¹ä¾¿è¿è¥å¿«é€Ÿä¸Šæ‰‹

### å¯è§†åŒ–æ­å»º

å¯è§†åŒ–æ­å»ºå®ç°ä¸»è¦é€šè¿‡ä¸»ç«™å’Œç¼–è¾‘å™¨ä¹‹é—´å»ºç«‹é€šä¿¡ç®¡é“ï¼Œå°†ç”¨æˆ·éœ€è¦æ‰§è¡Œçš„æ“ä½œï¼ˆæ–°å¢ç»„ä»¶ã€æ’åºã€åˆ é™¤ç­‰ï¼‰è½¬ä¸ºæ•°æ®ä¿¡æ¯ä¼ é€’ç»™ç¼–è¾‘å™¨ï¼Œç¼–è¾‘å™¨å†…éƒ¨å†æ ¹æ®ä¸åŒæ“ä½œæ‰§è¡Œä¸åŒçš„æ•°æ®å¤„ç†ï¼Œä»è€Œå®ç°è¡¨å•çš„åŠ¨æ€åŒ–æ›´æ–°ã€‚

![](https://proxy-prod.omnivore-image-cache.app/0x0,sLjDod6EuiZxouTU27G9i0PB-cHpaNBi3RNfdcTn6c-w/https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1079e8341f4648f0ac638cb55910f40a~tplv-k3u1fbpfcp-image.image#?w=582&h=191&s=4328&e=svg&a=1&b=070707)

#### é€šä¿¡è®¾è®¡

æˆ‘ä»¬å¸Œæœ›ä¸»ç«™èƒ½å¤Ÿå’Œç¼–è¾‘å™¨è¿›è¡Œè§£è€¦ï¼ŒåŒæ—¶ä¿è¯é…ç½®æœŸé—´è¡¨å•çš„æ ·å¼å’Œå®é™…è¡¨å•ä¸€è‡´ï¼Œå®ç°æ‰€è§å³æ‰€å¾—ï¼Œæ•…ç¼–è¾‘å™¨å†…çš„è¡¨å•åº”è¯¥ç›´æ¥é€šè¿‡formily + ç»„ä»¶åº“è¿›è¡Œæ¸²æŸ“ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©ç¼–è¾‘å™¨ä½¿ç”¨iframeçš„å½¢å¼ï¼Œé€šè¿‡postMessageè¿›è¡Œé€šä¿¡ï¼Œä¸ä»…å¤©ç„¶å®ç°è§£è€¦éš”ç¦»ï¼Œä¸»ç«™ä¹Ÿä¸éœ€è¦å¼•å…¥formilyåŠç§»åŠ¨ç«¯ç»„ä»¶åº“èµ„æºï¼ŒåŒæ—¶ä¹Ÿä¿è¯äº†è¡¨å•æ ·å¼çš„ä¸€è‡´æ€§ã€‚

```javascript
// admin to editor
export function postMsgToChild(message) {
  document.getElementById('frame')?.contentWindow?.postMessage(message, '*');
}

//  editor to admin
export function postMsgToParent (message) {
  window.parent.postMessage(
    message,
    '*'
  );
}


//admin

postMsgToChild({
  action: 'add',
  data: {
    componentName: 'xxx',
    props: {}
  }
})

//  editor

window.addEventListener('message', (e) => {
  const { action, data } = e.data

  switch (action) {
      // add/remove/copy/sort/changeProps/changeReactions
      // ç¼–è¾‘å™¨æ¥æ”¶åˆ°å¯¹åº”çš„actionè°ƒç”¨ä¸åŒçš„æ–¹æ³•æ¥å®ç°å¯¹åº”æ•°æ®æ“ä½œ
    case 'add':
    	// todo
      break;
  }
  
})

```

#### ç¼–è¾‘å™¨è®¾è®¡

ç”±äºç¼–è¾‘å™¨å’Œä¸»ç«™è¿›è¡Œäº†éš”ç¦»ï¼Œæˆ‘ä»¬å°†å¯ç”¨ç»„ä»¶ä»¥åŠé…ç½®æ”¾ç½®åœ¨ç¼–è¾‘å™¨å†…ï¼ˆå…·ä½“åŸå› åé¢ä¼šæåŠï¼‰ï¼Œé€šè¿‡æ¶ˆæ¯é€šä¿¡å‘ŠçŸ¥ä¸»ç«™å¯ç”¨ç»„ä»¶åˆ—è¡¨ä»¥åŠç»„ä»¶çš„æ‰€æœ‰å¯é…ç½®å±æ€§ã€‚

ç¼–è¾‘å™¨æ ¸å¿ƒç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š

```javascript
const [components, setComponents] = useState([])  // ç”¨æˆ·æ·»åŠ çš„æ‰€æœ‰ç»„ä»¶
const [curIndex, setCurIndex] = useState(0) // å½“å‰é€‰æ‹©çš„ç»„ä»¶ä¸‹æ ‡

// æ·»åŠ 
const add = (data) => {}
// åˆ é™¤
const remove = (data) => {}
// å¤åˆ¶
const copy = (data) => {}
// æ’åº
const sort = (data) => {}
// ä¿®æ”¹å±æ€§
const changeProps = () => {}
// ä¿®æ”¹è”åŠ¨
const changeReactions = () => {}
// å°†componentsè½¬ä¸ºjsonSchema ç”¨äºformilyæ¸²æŸ“è¡¨å•
const components2JsonSchema = (data) => {}

```

æˆ‘ä»¬åªéœ€åœ¨æ¥æ”¶åˆ°ä¸»ç«™çš„ä¸åŒæŒ‡ä»¤æ‰§è¡Œä¸åŒçš„æ–¹æ³•å»æ“ä½œcomponentsï¼Œæœ€ç»ˆé€šè¿‡components2JsonSchemaæ–¹æ³•ç”ŸæˆjsonSchemaç”¨äºè¡¨å•æ¸²æŸ“å³å¯ï¼Œé‚£æˆ‘ä»¬ä¸€ä¸ªç»„ä»¶ä¼šåŒ…å«å“ªäº›ä¸œè¥¿å‘¢ï¼Ÿ

å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªè¾“å…¥æ¡†ç»„ä»¶ï¼Œè¿™ä¸ªç»„ä»¶çš„é…ç½®åº”å½“åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

##### ç»„ä»¶é…ç½®

ç»„ä»¶é…ç½®æè¿°äº†ç»„ä»¶æ”¯æŒçš„æ‰€æœ‰propså±æ€§çš„é…ç½®

```lasso
const componentSchema = {
  "name": "Input",
  "description": "è¾“å…¥æ¡†",
  // ç»„ä»¶å¯é…ç½®å±æ€§æè¿°
  "props": {
    "type": "object",
    "properties": {
      "placeholder": {
        "title": "placeholder",
        "x-decorator": "FormItem",
        "x-decorator-props": {
          "tooltip": "å ä½ç¬¦"
        },
        "x-component": "Input",
        "x-component-props": {}
      },
      // å…¶ä»–å±æ€§
      ......
    }
  }
}

```

##### è¡¨å•å±æ€§

è¡¨å•å±æ€§ä¸»è¦ç”¨äºé…ç½®formilyè¡¨å•ç›¸å…³çš„å±æ€§ï¼štitleã€requiredã€enum......

```lasso
const formSchema = {
  "title": "è¡¨å•å±æ€§",
  "type": "object",
  "properties": {
    "title": {
      "title": "æ ‡é¢˜",
      "type": "string",
      "x-component": "Input",
      "x-decorator": "FormItem"
    },
    // å…¶ä»–å±æ€§
    ......
  }
}

```

##### å¸ƒå±€å±æ€§ï¼ˆdecorator propsï¼‰

å¸ƒå±€å±æ€§ä¸»è¦ç”¨äºé…ç½®FormItemçš„propså±æ€§

```lasso
const decoratorSchema = {
  "props": {
    "type": "object",
    "properties": {
      "colon": {
        "title": "colon",
        "x-decorator": "FormItem",
        "x-decorator-props": {
          "tooltip": "æ˜¯å¦æ˜¾ç¤ºlabelå³ä¾§å†’å·"
        },
        "x-component": "Switch"
      },
      // å…¶ä»–å±æ€§
      ......
    }
  }

```

æœ€ç»ˆæˆ‘ä»¬ç»™åˆ°ä¸»ç«™çš„ä¸€ä¸ªå®Œæ•´ç»„ä»¶çš„é…ç½®jsonå¤§è‡´å¦‚ä¸‹ï¼š

```vim
const postMsg = {
  type: 'props',
  data: {
  // å³ä¾§å±æ€§é¢æ¿è¡¨å•æ¸²æŸ“
    schema: {
      type: 'void',
      'x-decorator': 'FormItem',
      'x-component': 'FormCollapse',
      'x-component-props': {
        formCollapse: '{{formCollapse}}',
      },
      properties: {
        formSchema,
        componentSchema,
        decoratorSchema,
      },
      // å³ä¾§å±æ€§é¢æ¿è¡¨å•value
      props: {
        formSchema: {},
        componentSchema: {},
        decoratorSchema: {}
      }
    },
  },
}

```

è¿™æ ·å½“æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªInputç»„ä»¶åï¼Œä¸»ç«™å°±å¯ä»¥é€šè¿‡schemaæ¸²æŸ“ç»„ä»¶å¯ç”¨å±æ€§çš„é…ç½®é¢æ¿ï¼Œå½“ä¿®æ”¹å±æ€§é…ç½®åé€šè¿‡æ¶ˆæ¯é€šä¿¡å°†ä¿®æ”¹çš„æ•°æ®å‘ŠçŸ¥ç¼–è¾‘å™¨ï¼Œç¼–è¾‘å™¨å†æ ¹æ®æ•°æ®ç”ŸæˆjsonSchemaæ¸²æŸ“è¡¨å•

![](https://proxy-prod.omnivore-image-cache.app/0x0,sRNtnUHKCN3A_oCPOR6vkO14kJRuUAEM-y4zbwUmvgKQ/https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2dd2656c0dd249fd838cfa05cdc2ceb6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2554&h=1239&s=145755&e=png&b=fafafa)

ä¸Šé¢æˆ‘ä»¬çš„ç¡®å®ç°äº†ä¸€ä¸ªç»„ä»¶çš„å±æ€§é…ç½®ï¼Œä½†æ˜¯è¿™é‡Œåˆäº§ç”Ÿäº†å‡ ä¸ªé—®é¢˜ï¼š

* ç»„ä»¶åº“æœ‰è¿™ä¹ˆå¤šç»„ä»¶ï¼Œæ¯ä¸ªéƒ½è¦å†™ä¸€ä»½é…ç½®shcemaï¼Ÿ
* ç»„ä»¶åº“æ–°å¢/ä¿®æ”¹ç»„ä»¶ï¼Œåˆè¦æ‰‹åŠ¨å»ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Ÿ

æ˜¾ç„¶è¿™æ˜¯ä¸åˆç†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªèƒ½å¤Ÿè‡ªåŠ¨ç”Ÿæˆç»„ä»¶schemaçš„èƒ½åŠ›ï¼Œæ¥é¿å…äººå·¥é¢‘ç¹ä¿®æ”¹å’Œç»´æŠ¤ç»„ä»¶é…ç½®ã€‚

#### è‡ªåŠ¨ç”Ÿæˆç»„ä»¶é…ç½®

ä¸€å¼€å§‹æˆ‘ä»¬å¸Œæœ›ç»„ä»¶åº“çš„ç»´æŠ¤åŒå­¦èƒ½å¤Ÿåœ¨ç»„ä»¶åº“å†…éƒ¨å¯¼å‡ºä¸€ä»½ç»„ä»¶å±æ€§é…ç½®ï¼Œä½†è¿™æ ·åªæ˜¯å°†å·¥ä½œé‡è¿›è¡Œäº†è½¬ç§»ï¼Œå¹¶æ²¡æœ‰å®é™…è§£å†³æˆ‘ä»¬çš„é—®é¢˜ï¼Œè€Œä¸”å¯¹äºç»„ä»¶åº“ä¹Ÿæ˜¯ä¸€ç§å˜ç›¸çš„ä¾µå…¥ï¼Œæ¯•ç«Ÿè¿™ä»½é…ç½®æ–‡ä»¶å¯¹äºç»„ä»¶åº“è€Œè¨€å¹¶æ— æ„ä¹‰ï¼Œåªæ˜¯å•çº¯æä¾›æˆ‘ä»¬ä½¿ç”¨è€Œå·²ã€‚

æœ€ç»ˆæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ [typescript-json-schema](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FYousefED%2Ftypescript-json-schema "https://github.com/YousefED/typescript-json-schema") ã€[fast-typescript-to-jsonschema](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fyunke-yunfly%2Ffast-typescript-to-jsonschema "https://github.com/yunke-yunfly/fast-typescript-to-jsonschema")ï¼Œé€šè¿‡å°†ç»„ä»¶åº“å¯¼å‡ºçš„tså®šä¹‰è½¬ä¸ºjsonSchemaï¼Œè§£å†³äº†äººå·¥æ‰‹åŠ¨ç»´æŠ¤çš„é—®é¢˜ï¼Œå¹¶ä¸”æˆ‘ä»¬è¿˜å¯¹å†…éƒ¨å¯¹äºæ³¨é‡Šè§£æè¿›è¡Œäº†ä¸€å®šçš„æ”¹é€ ï¼Œé€šè¿‡è¯†åˆ«æŒ‡å®šæ³¨é‡Šå‰ç¼€ï¼Œç”Ÿæˆä¸åŒçš„å­—æ®µç»“æ„

```d
// ts å®šä¹‰ 
export interface Test {
  /**
   * @title this is test title
   * @description this is test desc
   * @default multiple
   */
  test: string;

  /**
   * @title this is aaa title
   * @description this is aaa desc
   * @default true
   */
  aaa: boolean;
  /**
   * @default 1
   */
  bbb: number;
}


/**
* ç”Ÿæˆçš„json
* @titleçš„æ³¨é‡Šä½œä¸ºå±æ€§æ ‡é¢˜
* @descriptionçš„æ³¨é‡Šä½œä¸ºå±æ€§æè¿°
* @defaultçš„æ³¨é‡Šä½œä¸ºå±æ€§é»˜è®¤å€¼
*/

const json = {
  "Test": {
    "type": "object",
    {
      "test": {
        "type": "string",
        "description": "this is test desc",
        "title": "this is test title",
        "default": "multiple"
      },
      "aaa": {
        "type": "boolean",
        "description": "this is aaa desc",
        "title": "this is aaa title",
        "default": true
      },
      "bbb": {
        "type": "number",
        "default": 1
      }
    },
  }
}

// å†å°†json è½¬ä¸ºå¯ç”¨äºformilyæ¸²æŸ“çš„jsonschema

const schema = {
  name: "Test",
  properties: {
    "test": {
      default: "multiple",
      title: "this is test title",
      type: "string",
      "x-component": "Input",
      "x-decorator": "FormItem",
      "x-decorator-props": {
        "tooltip": "this is test desc"
      },
    },
    "aaa": {
      default: true,
      title: "this is aaa title",
      type": "boolean",
      "x-component": "Switch",
      "x-decorator": "FormItem",
      "x-decorator-props": {
        "tooltip": "this is aaa desc"
      }
    },
    "bbb": {
      default: 1,
      type: "number",
      "x-component": "NumberPicker",
      "x-decorator": "FormItem"
    }
  }
}


```

è¿™æ ·ç»„ä»¶åº“åªéœ€è°ƒæ•´ä¸‹ç»„ä»¶propsçš„æ³¨é‡Šï¼Œæ¯æ¬¡ç»„ä»¶åº“æ›´æ–°æˆ‘ä»¬åªéœ€åŒæ­¥å‡çº§ä¸‹ç¼–è¾‘å™¨å†…çš„ç»„ä»¶åº“å³å¯è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰ç»„ä»¶åŠç»„ä»¶çš„å±æ€§é…ç½®jsonshcemaäº†ï¼

### é€»è¾‘è”åŠ¨

æ­¤æ—¶çš„è¡¨å•è¿˜åªæ˜¯ä¸€å…·ç©ºæœ‰å®¹è²Œï¼ˆschemaï¼‰çš„è‚‰ä½“ï¼Œä¸€ä¸ªé™æ€çš„è¡¨å•æ˜¯æ— æ³•æ»¡è¶³æˆ‘ä»¬å°å§å§çš„éœ€æ±‚çš„ï¼Œå› æ­¤éœ€è¦ç»™è¡¨å•æ³¨å…¥çµé­‚ï¼ˆé€»è¾‘è”åŠ¨ï¼‰ã€‚

formilyæä¾›çš„è”åŠ¨èƒ½åŠ›ä¸»è¦æœ‰ä¸¤ç§ï¼š[SchemaReactions](https://link.juejin.cn/?target=https%3A%2F%2Freact.formilyjs.org%2Fzh-CN%2Fapi%2Fshared%2Fschema%23schemareactions "https://react.formilyjs.org/zh-CN/api/shared/schema#schemareactions")ã€[Effects](https://link.juejin.cn/?target=https%3A%2F%2Fcore.formilyjs.org%2Fzh-CN%2Fapi%2Fentry%2Fform-effect-hooks "https://core.formilyjs.org/zh-CN/api/entry/form-effect-hooks")ã€‚[SchemaReactions](https://link.juejin.cn/?target=https%3A%2F%2Freact.formilyjs.org%2Fzh-CN%2Fapi%2Fshared%2Fschema%23schemareactions "https://react.formilyjs.org/zh-CN/api/shared/schema#schemareactions")ä¸€èˆ¬ç”¨äºç›¸å¯¹æ¯”è¾ƒç®€å•çš„è¡¨å•å­—æ®µé—´çš„è”åŠ¨ï¼Œè€Œ[Effects](https://link.juejin.cn/?target=https%3A%2F%2Fcore.formilyjs.org%2Fzh-CN%2Fapi%2Fentry%2Fform-effect-hooks "https://core.formilyjs.org/zh-CN/api/entry/form-effect-hooks")æ”¯æŒæ›´å¤šå¤æ‚åœºæ™¯çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚æˆ‘ä»¬ä¹Ÿé’ˆå¯¹è¿™ä¸¤ç§é€»è¾‘è”åŠ¨èƒ½åŠ›è®¾è®¡äº†ä¸åŒçš„äº¤äº’å’Œå®ç°æ–¹å¼ã€‚

#### è¡¨å•å­—æ®µè”åŠ¨ï¼ˆSchemaReactionsï¼‰

æˆ‘ä»¬çŸ¥é“formilyçš„é€»è¾‘è”åŠ¨æœ‰ä¸»åŠ¨è”åŠ¨ã€ä¾èµ–è”åŠ¨ç­‰å¤šç§æ–¹å¼ï¼ŒåŒæ—¶æ”¯æŒè”åŠ¨çš„å±æ€§ä¹Ÿæœ‰å¾ˆå¤šï¼Œä½†æ˜¯æˆ‘ä»¬çš„ç”¨æˆ·å¹¶éå¼€å‘äººå‘˜ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åŠŸèƒ½æ˜“ç”¨æ€§å’Œå®Œæ•´æ€§ä¸Šè¿›è¡Œä¸€å®šçš„å–èˆï¼Œå› æ­¤æˆ‘ä»¬æœ€ç»ˆå†³å®šç»Ÿä¸€ä½¿ç”¨ä¾èµ–è”åŠ¨çš„æ–¹å¼ï¼Œå¹¶åªå¼€æ”¾éƒ¨åˆ†å¸¸ç”¨çš„å±æ€§æ”¯æŒé€»è¾‘è”åŠ¨ï¼Œå°½å¯èƒ½é™ä½è¿è¥çš„å­¦ä¹ å’Œä½¿ç”¨æˆæœ¬

æ¥ä¸‹æ¥é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥çœ‹ä¸‹æˆ‘ä»¬æ˜¯å¦‚ä½•å»å®ç°SchemaReactonsçš„è”åŠ¨é…ç½®ï¼š

æœ‰ä»¥ä¸‹ä¸€ä¸ªåœºæ™¯ï¼Œå½“é€‰é¡¹ä¸€æˆ–é€‰é¡¹äºŒçš„å€¼ä¸ºâ€œæ˜¯â€çš„æ—¶å€™ï¼Œåˆ™å±•ç¤ºå›¾ç‰‡ç»„ä»¶

![](https://proxy-prod.omnivore-image-cache.app/0x0,snurqhICf22AvGh9P3ZdCDRO--aisYcT9juWljzosYjM/https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c7ff7d8df51b42c8898d14dcbc44b828~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=982&h=1458&s=460000&e=png&b=fcfcfc)

å¯¹åº”çš„Schemaå¦‚ä¸‹

```json
// åˆå§‹ schema

{
  "type": "object",
  "properties": {
    "select1": {
      "title": "é€‰é¡¹ä¸€",
      "type": "string",
      "x-decorator": "FormItem",
      "x-component": "Radio.Group",
      "enum": [
      	{ "label": "æ˜¯", "value": "æ˜¯" },
        { "label": "å¦", "value": "å¦" }
      ]
    },
    "select2": {
      "title": "é€‰é¡¹äºŒ",
      "type": "string",
      "x-decorator": "FormItem",
      "x-component": "Radio.Group",
      "enum": [
      	{ "label": "æ˜¯", "value": "æ˜¯" },
        { "label": "å¦", "value": "å¦" }
      ]
    },
    "image": {
      "type": "string",
      "x-component": "Image"
    }
  }
}

```

é€šè¿‡é€‰ä¸­å›¾ç‰‡ç»„ä»¶å¹¶è®¾ç½®å¯¹åº”çš„è”åŠ¨é€»è¾‘ï¼Œé…ç½®ç•Œé¢å¤§è‡´å¦‚ä¸‹ï¼š

![](https://proxy-prod.omnivore-image-cache.app/0x0,sPaliVGRstem-bJGNZ69vpBPojyd4ncLly2uTi0FlgZI/https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2caa5cb88d1e42df9d2ff1fd55fdf002~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2070&h=984&s=123312&e=png&b=fefefe)

ä¸Šè¿°é…ç½®å®é™…ç”Ÿæˆçš„reactionsé…ç½®å±æ€§å¤§è‡´å¦‚ä¸‹ï¼š

```cs
// å­˜å‚¨çš„reactionsé…ç½®

const reactions = {
  image: {
    display: { // è®¾ç½®æ˜¾éš
      condition: 'or', //  æ¡ä»¶å…³ç³»
      target: 'visible', // ç›®æ ‡ç»“æœ
      reactions: [
        {
          dependence: 'select1',
          attr: 'value',
          relation: '=',
          value: 'æ˜¯',
      	},
        {
          dependence: 'select2',
          attr: 'value',
          relation: '=',
          value: 'æ˜¯',
      	}
    	]
    }
  }
}

```

æäº¤æ—¶åªéœ€å°†ä¸Šè¿°çš„é…ç½®å±æ€§è½¬æ¢æˆå¯¹åº”çš„SchemaReactionsè¡¨è¾¾å¼å³å¯ï¼š

```json
//  è½¬æ¢å schema

{
  "type": "object",
  "properties": {
    "select1": {
      "title": "é€‰é¡¹ä¸€",
      "type": "string",
      "x-decorator": "FormItem",
      "x-component": "Radio.Group",
      "enum": [
      	{ "label": "æ˜¯", "value": "æ˜¯" },
        { "label": "å¦", "value": "å¦" }
      ]
    },
    "select2": {
      "title": "é€‰é¡¹äºŒ",
      "type": "string",
      "x-decorator": "FormItem",
      "x-component": "Radio.Group",
      "enum": [
      	{ "label": "æ˜¯", "value": "æ˜¯" },
        { "label": "å¦", "value": "å¦" }
      ],
    },
    "image": {
      "type": "string",
      "x-component": "Image",
       "x-reactions": {
        "fulfill": {
          "state": {
            "display": "{{($deps[0] === 'æ˜¯' || $deps[1] === 'æ˜¯') ? 'visible' : 'none'}}"
          }
        },
        "dependencies": ["select1", "select2"]
      }
    }
  }
}

```

#### ä¸šåŠ¡é€»è¾‘è”åŠ¨ï¼ˆEffectsï¼‰

æˆ‘ä»¬ç›®å‰éœ€è¦ä½¿ç”¨Effectsçš„åœºæ™¯å¤§éƒ¨åˆ†æ˜¯æµç¨‹ç±»è¡¨å•ï¼Œå³åœ¨ä¸åŒçš„æµç¨‹èŠ‚ç‚¹æˆ‘ä»¬å…¬ç”¨åŒä¸€ä»½è¡¨å•é…ç½®ï¼Œé€šè¿‡åœ¨ä¸åŒçš„èŠ‚ç‚¹æ‰§è¡Œä¸€ä¸ªå¯¹åº”çš„hookæ–¹æ³•ï¼Œæ–¹æ³•å†…éƒ¨ä¸»è¦åˆ©ç”¨formily Effectsæä¾›çš„èƒ½åŠ›æ¥å®ç°å¯¹åº”çš„ä¸šåŠ¡é€»è¾‘ï¼Œä»¥æ­¤æ¥å±•ç¤ºä¸åŒçš„è¡¨å•å­—æ®µã€çŠ¶æ€ã€æ ·å¼ç­‰ã€‚

![](https://proxy-prod.omnivore-image-cache.app/0x0,so9EbPDQ_tkhfjIfpok1D8_aQV43DJF70fol3bGc58qs/https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/50ec69f5d2b2493d91b6ffe1e9f0682a~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=780&h=848&s=37992&e=jpg&b=fefefe)

åŒæ ·ï¼Œæˆ‘ä»¬ä¹Ÿé€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥çœ‹ä¸‹æ˜¯å¦‚ä½•å»å®ç°Effectsçš„è”åŠ¨é…ç½®ï¼š

å‡å¦‚æœ‰è¿™ä¹ˆä¸€ä¸ªéœ€æ±‚ï¼šåœ¨æµç¨‹èŠ‚ç‚¹Aæ—¶éœ€è¦éšè—select1ã€select2å­—æ®µï¼Œæ­¤å‰çš„å®ç°æ–¹å¼ä¸ºé€šè¿‡åœ¨å¯¹åº”èŠ‚ç‚¹çš„hookç¼–å†™å¦‚ä¸‹ä»£ç ï¼š

```javascript
function __execute() {
  formilyCoreApi.onFormMount(() => {
    const fields = form.query('*(select1, select2)')
    fields.forEach(field => field.setDisplay('none'))
  })
}; 
__execute()

```

ä½†æ˜¯æˆ‘ä»¬ä¸å¯èƒ½è®©è¿è¥å»å†™è¿™ä¹ˆä¸€å—ä»£ç ï¼ŒåŒæ—¶ä¸èƒ½ä¹Ÿä¸åº”è¯¥è®©å¼€å‘ä¸ºæ¯ä¸ªéœ€è¦æ‰§è¡Œç±»ä¼¼é€»è¾‘çš„è¡¨å•å»ç¼–å†™ä»£ç ï¼Œå¦åˆ™å°±å¤±å»äº†è¡¨å•æ­å»ºçš„æ„ä¹‰ï¼Œæˆ‘ä»¬ç»™å‡ºçš„è§£å†³æ–¹æ¡ˆæ˜¯é€šè¿‡ä»¥æœ€å°ç²’åº¦å°†æ¯ä¸ªåŠ¨ä½œï¼ˆæ¯”å¦‚ä¸Šè¿°çš„è®¾ç½®å­—æ®µéšè—ï¼‰è½¬ä¸ºä¸€ä¸ªä¸ªç±»ä¼¼æ’ä»¶å½¢å¼çš„æ–¹æ³•ï¼Œä¾›ç”¨æˆ·ç»„åˆä½¿ç”¨æ¥å®ç°ä¸šåŠ¡è¯‰æ±‚ï¼Œå½“ç°æœ‰æ’ä»¶ä¸æ»¡è¶³æ–°çš„ä¸šåŠ¡æ—¶ï¼Œå¼€å‘åªéœ€æ–°å¼€å‘ä¸€ä¸ªæ’ä»¶å³å¯ã€‚

![](https://proxy-prod.omnivore-image-cache.app/0x0,soxrBFRo0c9T-siDsaJBbr46NamxlI1NNOD-7Gfoionk/https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6796498db6a74e5894db06faeafd661b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=532&h=738&s=24059&e=jpg&b=ffffff)

ç”¨ä¸Šè¿°çš„å­—æ®µéšè—æ’ä»¶æ¥ä¸¾ä¾‹ï¼Œä¸€ä¸ªæ’ä»¶ä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š

```javascript
const hookPlugin = {
  name: 'setNodesHidden', // æ’ä»¶æ–¹æ³•å
  title: 'å­—æ®µéšè—è®¾ç½®', // æ’ä»¶åç§°
  description: 'å¯é€‰æ‹©éœ€è¦çš„å­—æ®µåœ¨ä¸åŒæµç¨‹èŠ‚ç‚¹è¿›è¡Œéšè—', // æè¿°
  version: '1.0.0', // ç‰ˆæœ¬
  // ç”¨äºæè¿°ç”¨æˆ·é€‰æ‹©hookæ’ä»¶åçš„æ“ä½œè§†å›¾
  jsonSchema:{
    "type": "object",
    "properties": {
      "schemaKeys": {
        "type": "array",
        "x-decorator": "FormItem",
        "x-component": "SelectTable",
        "required": true,
        "x-component-props": {
          "bordered": false,
          "mode": "multiple"
        },
        "enum": [],
        "properties": {
          "label": {
            "title": "éœ€è¦éšè—çš„å­—æ®µå",
            "type": "string",
            "x-component": "SelectTable.Column"
          }
        }
      }
  	}
  },
  // ç”¨äºæè¿°ç”¨æˆ·é€‰æ‹©hookæ’ä»¶åçš„äº¤äº’é€»è¾‘å¤„ç†
  effects: function (jsonSchema, formilyCoreApi, nodeId, formData) {
  /**
  	jsonSchema: ä¸ºè¡¨å•çš„jsonSchemaï¼Œéæ’ä»¶é…ç½®ç•Œé¢çš„jsonSchema
    formilyCoreApi: formily core ç›¸å…³æ–¹æ³•
    nodeId: æµç¨‹èŠ‚ç‚¹id
    formData: æ’ä»¶é…ç½®ç•Œé¢æ•°æ®
  */
  formilyCoreApi.onFormMount((f) => {
    // å¦‚æœå­˜åœ¨formData  ä¸€èˆ¬ä¸ºç”¨æˆ·ç¼–è¾‘è¯¥æ’ä»¶
    f.setValues({ schemaKeys: formData || [] });
    const data = Object.keys(jsonSchema.properties).map((k) => {
      const { title, customKey } = jsonSchema.properties[k];
      return {
        label: title || customKey,
        key: k,
      };
    });
    const schemaKeysField = f.query('schemaKeys').take();
    schemaKeysField?.setDataSource(data);
  });

  formilyCoreApi.onFormSubmitValidateEnd((f) => {
    // è¿™é‡Œå¯ä»¥æ‰‹åŠ¨å¹²é¢„æäº¤çš„æ•°æ®ï¼Œæäº¤çš„æ•°æ®å°†ä½œä¸ºhook function çš„ params
    f.values = f.values.schemaKeys;
  });
}, 
  // è¡¨å•å®é™…æ‰§è¡Œçš„effectsä»£ç 
  hook: function setNodesHidden(keys, global) {
    const { formilyCoreApi, form } = global;
    formilyCoreApi.onFormMount(() => {
      const fields = form.query(`*(${keys.join(',')})`);
      fields.forEach((field) => field.setDisplay('none'));
    });
  },
}

```

è¿™é‡Œçš„jsonSchemaå’Œeffectsæ˜¯ç”¨äºæè¿°å½“ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªæ’ä»¶åéœ€è¦æ“ä½œçš„äº¤äº’ï¼Œæ¯”å¦‚å½“æˆ‘é€‰æ‹©â€œå­—æ®µéšè—è®¾ç½®â€è¿™ä¸ªæ’ä»¶åä¼šæœ‰ä¸€ä¸ªé…ç½®ç•Œé¢æ¥è®©ç”¨æˆ·é€‰æ‹©éœ€è¦éšè—çš„å­—æ®µï¼Œè¿™ä¸ªé…ç½®ç•Œé¢å°±æ˜¯é€šè¿‡è¿™é‡Œçš„jsonSchemaå’Œeffectså»å®ç°çš„ã€‚

![](https://proxy-prod.omnivore-image-cache.app/0x0,so-YLhDWJSlOadQ48WUsPryK-62BIoEkRpNc0m9XWLls/https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/88000975fc8144c18adc045d8b8c76d5~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=431&h=912&s=27266&e=jpg&b=fefefe)

![](https://proxy-prod.omnivore-image-cache.app/0x0,stpYxHg4nb4WHrnis0dN1yDvFwQQPH7-xumPXL6SZKyQ/https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f5e9ab97d34740058be8aeee63e18270~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=806&h=426&s=42401&e=png&b=fefefe)

æœ€ç»ˆå½“ç”¨æˆ·åœ¨èŠ‚ç‚¹Aæ‰§è¡Œçš„hookæ–¹æ³•å®é™…ä»£ç å¦‚ä¸‹ï¼š

```reasonml

function __execute() {
  setNodesHidden(["select1","select2"], this);
  // å¦‚æœä½¿ç”¨å¤šä¸ªæ’ä»¶åˆ™ä¼šä¾æ¬¡æ‰§è¡Œ
  ......
};
__execute();

```

è‡³æ­¤ä¸€ä¸ªå®Œæ•´çš„è¡¨å•å°±æ­å»ºå¥½äº†ï¼ŒåŒ…å«äº†jsonSchemaã€reactionsã€effectsä¸‰å—æ ¸å¿ƒèƒ½åŠ›ï¼Œå½“ç„¶å›´ç»•è¡¨å•æ­å»ºæˆ‘ä»¬è¿˜å¯ä»¥åšå¾ˆå¤šå…¶ä»–æœåŠ¡ä¸šåŠ¡çš„åŠŸèƒ½ï¼Œè¿™é‡Œå°±ä¸å±•å¼€å™è¿°äº†ã€‚

## ç»“è¯­

è‡ªè¡¨å•æ­å»ºå¹³å°ä¸Šçº¿è‡³ä»Šå·²æœ‰3ä¸ªæœˆçš„æ—¶é—´ï¼Œæˆ‘ä»¬å†…éƒ¨çš„è¡¨å•é…ç½®ç­”ç–‘ç¾¤é™¤å»åˆšä¸Šçº¿æœŸé—´çš„ä¸€äº›é—®é¢˜è§£ç­”å’Œéƒ¨åˆ†å°åŠŸèƒ½è¿­ä»£å¤–ï¼ŒåŸºæœ¬æ²¡æœ‰å†æ¥åˆ°éœ€è¦å¼€å‘å¸®å¿™é…ç½®è¡¨å•çš„è¯‰æ±‚ï¼Œç¾ä¸­ä¸è¶³çš„å°±æ˜¯å°‘äº†è®¸å¤šå’Œè¿è¥å°å§å§äº’åŠ¨çš„æœºä¼šäº†

![](https://proxy-prod.omnivore-image-cache.app/0x0,sRTEB2FJj495iiJSkTfFiHsCUB6UFjDjmvidsHo97TVc/https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/15384240544c41118b18159935f3d7e6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=240&h=179&s=7038&e=jpg&b=fcfcfc)

## æœ€å

ğŸ“š å°èŒ—æ–‡ç« æ¨èï¼š

* [å‰ç«¯å¼€å‘è€…éœ€è¦äº†è§£çš„ã€Œè®¾è®¡ä½“ç³»ã€](https://juejin.cn/post/7308434314777018378 "https://juejin.cn/post/7308434314777018378")
* [é—¨åº—æ™ºèƒ½è®¾å¤‡é—´ã€Œé€šä¿¡ã€åŸç†](https://juejin.cn/post/7305348040210006052 "https://juejin.cn/post/7305348040210006052")
* [ã€Œå‰ç«¯æ·»åŠ æ°´å°ã€ä½ çœŸçš„äº†è§£å…¨é¢å—ï¼Ÿ](https://juejin.cn/post/7302724955699822631 "https://juejin.cn/post/7302724955699822631")

å…³æ³¨å…¬ä¼—å·ã€Œ[Goodmeå‰ç«¯å›¢é˜Ÿ](https://link.juejin.cn/?target=https%3A%2F%2Fweb-oss.gumingnc.com%2Fassets%2F20230823%2FYy.rry6z%2Fqrcode%5Ffor%5Fgh%5F322c2d7a2432%5F344.jpg "https://web-oss.gumingnc.com/assets/20230823/Yy.rry6z/qrcode_for_gh_322c2d7a2432_344.jpg")ã€ï¼Œè·å–æ›´å¤šå¹²è´§å®è·µï¼Œæ¬¢è¿äº¤æµåˆ†äº«\~

---

